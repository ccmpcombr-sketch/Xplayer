<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Player com Categorias e √Ålbuns</title>

<!-- Metatags Open Graph para Facebook -->
<meta property="og:title" content="Meu Player de V√≠deos">
<meta property="og:description" content="Assista aos v√≠deos diretamente pelo navegador!">
<meta property="og:image" content="https://raw.githubusercontent.com/ccmpcombr-sketch/Xplayer/main/cover.jpg">
<meta property="og:url" content="https://ccmpcombr-sketch.github.io/Xplayer/">
<meta property="og:type" content="website">

<style>
  body { margin:0; font-family: Arial, sans-serif; background:#001f3f; color:#fff; }
  .categories { display:flex; gap:10px; justify-content:center; margin:0; flex-wrap:wrap; padding:10px 0; }
  .categories button { padding:8px 15px; cursor:pointer; background:#228B22; color:#fff; border:none; border-radius:5px; }
  .categories button:hover, .categories button.active { background:#196619; }
  .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); gap:10px; padding:10px; }
  .card { background:#32CD32; border-radius:10px; overflow:hidden; display:flex; justify-content:center; align-items:center; flex-direction:column; }
  .card video { width:100%; display:block; height:120px; object-fit:cover; cursor:pointer; }
  .card .info { background: rgba(255, 255, 0, 0.7); color: #000; width: 100%; padding: 10px; font-size: 14px; text-align: center; }
  .card:hover { background:#000; }

  /* Player central */
  #playerCentral { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; justify-content:center; align-items:center; flex-direction: column; }
  #playerCentral video { width:100%; height:100%; background:#000; object-fit:cover; }
  #playerCentral.portrait video { width:100%; height:55%; object-fit:contain; }
  #playerCentral.landscape video { width:100%; height:auto; max-height:97%; object-fit:contain; }
  #closeBtn { position:absolute; top:10px; right:10px; background:red; border:none; padding:10px; color:#fff; cursor:pointer; border-radius:50%; display:none; z-index:10000; }
  #playerCentral.showClose #closeBtn { display:block; }
  #countdown { position:absolute; right:16px; bottom:60px; background:rgba(0,0,0,0.7); color:#fff; padding:4px 8px; border-radius:4px; font-size:14px; font-weight:bold; display:none; z-index:10002; }
  #skipBtn { position:absolute; right:16px; bottom:60px; background:rgba(0,0,0,0.7); color:#fff; padding:4px 8px; border-radius:4px; font-size:14px; font-weight:bold; display:none; cursor:pointer; pointer-events:none; transition:background 0.3s; z-index:10002; }
  #skipBtn.enabled { background:#007BFF; pointer-events:auto; }
  #saibaMaisBtn { position:absolute; right:16px; bottom:30px; background:#28a745; color:#fff; padding:4px 8px; border-radius:4px; font-size:14px; font-weight:bold; display:none; cursor:pointer; z-index:10001; }
  #saibaMaisBtn:hover { background:#218838; }
  .like-btn { display:inline-flex; align-items:center; gap:4px; border:none; background:transparent; color:#1877f2; cursor:pointer; font-size:14px; }
  .like-icon { fill:currentColor; transition: transform 0.3s ease, fill 0.3s ease; width:18px; height:18px; }
  .like-btn[aria-pressed="true"] .like-icon { fill:#0d65d9; transform: scale(1.2); }
</style>
</head>
<body>

<div class="categories" id="categories"></div>
<div class="grid" id="grid"></div>

<div id="playerCentral">
  <button id="closeBtn">X</button>
  <video id="mainVideo" controls autoplay muted playsinline></video>
  <div id="countdown"></div>
  <div id="skipBtn">Pular an√∫ncio</div>
  <div id="saibaMaisBtn">Saiba Mais</div>
</div>

<script src="https://www.gstatic.com/firebasejs/12.2.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.2.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig={
  apiKey:"AIzaSyA7LidrFCtjqTa-gW6yXE7KRO5XSOBeySQ",
  authDomain:"likesccmp.firebaseapp.com",
  databaseURL:"https://likesccmp-default-rtdb.firebaseio.com/",
  projectId:"likesccmp",
  storageBucket:"likesccmp.firebasestorage.app",
  messagingSenderId:"840098736888",
  appId:"1:840098736888:web:8442373c56946e1b49690d"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
</script>

<script>
const GITHUB_USER="ccmpcombr-sketch";
const REPO="mini-players";
const BRANCH="main";
const FILE_PATH="miniPlayers.json";
const RAW_URL=`https://raw.githubusercontent.com/${GITHUB_USER}/${REPO}/${BRANCH}/${FILE_PATH}`;

let allData={}, selectedCategory=null, currentPlaylist=[], playlistIndex=0;
let hideTimeout, countdownInterval, skipCountdownInterval, adCountdownInterval;

async function loadData(){
  try{
    const res=await fetch(`${RAW_URL}?t=${Date.now()}`,{cache:"no-store"});
    const json=await res.json();
    if(JSON.stringify(json)!==JSON.stringify(allData)){
      allData=json;
      renderCategories();
      if(selectedCategory) renderAlbums(selectedCategory);
    }
  }catch(err){ console.error(err); }
}
setInterval(loadData,5000);
loadData();

function renderCategories(){
  const categoriesDiv=document.getElementById("categories");
  categoriesDiv.innerHTML="";
  Object.keys(allData).forEach(cat=>{
    const btn=document.createElement("button");
    btn.textContent=cat.charAt(0).toUpperCase()+cat.slice(1);
    btn.dataset.cat=cat;
    btn.onclick=()=>{ selectedCategory=cat; renderAlbums(cat); document.querySelectorAll(".categories button").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); };
    categoriesDiv.appendChild(btn);
  });
}

function renderAlbums(category){
  const grid=document.getElementById("grid");
  grid.innerHTML="";
  const albums=allData[category];
  if(!albums) return;
  Object.keys(albums).forEach(albumName=>{
    const album=albums[albumName];
    if(typeof album==="object" && !Array.isArray(album)){
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`<div class="info"><strong>üìÅ ${albumName}</strong></div>`;
      card.onclick=()=>renderSubAlbums(category,albumName,album);
      grid.appendChild(card);
    } else {
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`<div class="info"><strong>${albumName}</strong></div>`;
      card.onclick=()=>renderMiniPlayers(category,albumName);
      grid.appendChild(card);
    }
  });
}

function renderSubAlbums(category,albumName,albumObj){
  const grid=document.getElementById("grid");
  grid.innerHTML="";
  Object.keys(albumObj).forEach(subAlbumName=>{
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<div class="info"><strong>${subAlbumName}</strong></div>`;
    card.onclick=()=>renderMiniPlayers(category,albumName,subAlbumName);
    grid.appendChild(card);
  });
}

function renderMiniPlayers(category,albumName,subAlbumName=null){
  const grid=document.getElementById("grid");
  grid.innerHTML="";
  let miniPlayers=subAlbumName?allData[category][albumName][subAlbumName]:allData[category][albumName];
  if(!miniPlayers) return;

  miniPlayers.forEach(mp=>{
    const card=document.createElement("div");
    card.className="card";
    const coverUrl=(mp["lista de reprodu√ß√£o oculta"]&&mp["lista de reprodu√ß√£o oculta"][0])?mp["lista de reprodu√ß√£o oculta"][0].url:(mp.url||"");
    const viewId=`view-${mp.t√≠tulo}`;
    const likeId=`like-${mp.t√≠tulo}`;
    card.innerHTML=`
      <video src="${coverUrl}" muted autoplay loop playsinline class="mini-video"></video>
      <div class="info">
        <strong>${mp.t√≠tulo}</strong><br>${mp.desc||""}<br>
        <div id="${viewId}">üëÅÔ∏è 0</div>
        <button id="${likeId}" class="like-btn" aria-pressed="false">
          <svg class="like-icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5 c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
          <span>0</span>
        </button>
      </div>
    `;
    grid.appendChild(card);

    const miniVideo=card.querySelector(".mini-video");
    miniVideo.addEventListener("click",()=> openPlayer(mp));

    const viewEl=document.getElementById(viewId);
    const likeBtn=document.getElementById(likeId);
    const likeCountEl=likeBtn.querySelector("span");
    initRealtimeFirebase(mp.t√≠tulo,viewEl,likeCountEl,likeBtn);
  });
}

function initRealtimeFirebase(id,viewEl,likeCountEl,likeBtn){
  const viewRef=db.ref("Visualizacoes/"+id);
  const likeRef=db.ref("Likes/"+id);
  viewRef.transaction(curr=>(curr||0)+1);
  viewRef.on("value",snap=>{ viewEl.textContent=`üëÅÔ∏è ${snap.val()||0}`; });
  const likedKey="liked-"+id;
  let liked=localStorage.getItem(likedKey)==="1";
  updateLikeBtn(likeBtn,liked);
  likeRef.once("value",snap=>{ if(snap.val()===null) likeRef.set(0); });
  likeRef.on("value",snap=>{ likeCountEl.textContent=snap.val()||0; });
  likeBtn.onclick=e=>{
    e.stopPropagation();
    likeRef.transaction(curr=>{
      let current=curr||0;
      if(liked){ liked=false; current=Math.max(0,current-1); }
      else{ liked=true; current++; }
      localStorage.setItem(likedKey,liked?"1":"0");
      updateLikeBtn(likeBtn,liked);
      return current;
    });
  };
}

function updateLikeBtn(btn,liked){ btn.setAttribute("aria-pressed",liked?"true":"false"); }

// --- Player central ---
function openPlayer(mp){
  const player=document.getElementById("playerCentral");
  const video=document.getElementById("mainVideo");
  const grid=document.getElementById("grid");
  const categories=document.getElementById("categories");

  currentPlaylist=mp["lista de reprodu√ß√£o oculta"]||[];
  playlistIndex=0;
  if(currentPlaylist.length===0&&mp.url) currentPlaylist.push({url:mp.url,t√≠tulo:mp.t√≠tulo,tipo:"normal"});
  if(currentPlaylist.length===0) return;

  categories.style.display="none";
  grid.style.display="none";
  playVideo(video,currentPlaylist[playlistIndex]);
  player.style.display="flex";
  handleOrientation();
  showCloseBtnTemporarily();
}

function playVideo(video,item){
  clearInterval(countdownInterval);
  clearInterval(skipCountdownInterval);
  clearInterval(adCountdownInterval);
  const countdownEl=document.getElementById("countdown");
  const skipBtn=document.getElementById("skipBtn");
  const saibaMaisBtn=document.getElementById("saibaMaisBtn");

  countdownEl.style.display="none";
  skipBtn.style.display="none"; skipBtn.classList.remove("enabled");
  saibaMaisBtn.style.display="none";

  video.src=item.url;
  video.muted=false;
  video.play();

  if(item.tipo==="normal"){
    video.ontimeupdate=()=>{
      if(video.duration-video.currentTime<=5&&video.duration>5){
        let remaining=5;
        countdownEl.style.display="block";
        countdownEl.textContent=`An√∫ncio em ${remaining}`;
        countdownInterval=setInterval(()=>{
          remaining--;
          if(remaining>0) countdownEl.textContent=`An√∫ncio em ${remaining}`;
          else countdownEl.style.display="none";
        },1000);
        video.ontimeupdate=null;
      }
    };
  }

  if(item.tipo==="anuncio"){
    saibaMaisBtn.style.bottom="30px";
    saibaMaisBtn.style.display="block";
    if(item.link) saibaMaisBtn.onclick=()=>window.open(item.link,"_blank");

    if(item.pulavel===false){
      countdownEl.style.display="block";
      adCountdownInterval=setInterval(()=>{
        const remaining=Math.max(0,Math.floor(video.duration-video.currentTime));
        const m=String(Math.floor(remaining/60)).padStart(2,"0");
        const s=String(remaining%60).padStart(2,"0");
        countdownEl.textContent=`O an√∫ncio termina em ${m}:${s}`;
        if(remaining<=0){ countdownEl.style.display="none"; clearInterval(adCountdownInterval); }
      },500);
    } else {
      let remaining=5;
      skipBtn.style.bottom="60px";
      skipBtn.style.display="block";
      skipBtn.disabled=true;
      skipBtn.textContent=`Pular an√∫ncio em ${remaining}`;
      skipCountdownInterval=setInterval(()=>{
        remaining--;
        if(remaining>0) skipBtn.textContent=`Pular an√∫ncio em ${remaining}`;
        else{
          skipBtn.textContent="Pular an√∫ncio";
          skipBtn.disabled=false;
          skipBtn.classList.add("enabled");
          clearInterval(skipCountdownInterval);
        }
      },1000);
    }
  }

  video.onended=()=>{
    playlistIndex++;
    if(playlistIndex<currentPlaylist.length) playVideo(video,currentPlaylist[playlistIndex]);
    else closePlayer();
  };
}

document.getElementById("skipBtn").onclick=()=>{
  const video=document.getElementById("mainVideo");
  if(!document.getElementById("skipBtn").classList.contains("enabled")) return;
  video.pause();
  playlistIndex++;
  if(playlistIndex<currentPlaylist.length) playVideo(video,currentPlaylist[playlistIndex]);
  else closePlayer();
};

function closePlayer(){
  const player=document.getElementById("playerCentral");
  const video=document.getElementById("mainVideo");
  const grid=document.getElementById("grid");
  const categories=document.getElementById("categories");
  video.pause();
  player.style.display="none";
  player.classList.remove("showClose","portrait","landscape");
  categories.style.display="flex";
  grid.style.display="grid";
  clearTimeout(hideTimeout);
  clearInterval(countdownInterval);
  clearInterval(skipCountdownInterval);
  clearInterval(adCountdownInterval);
}

function showCloseBtnTemporarily(){
  const player=document.getElementById("playerCentral");
  player.classList.add("showClose");
  clearTimeout(hideTimeout);
  hideTimeout=setTimeout(()=>player.classList.remove("showClose"),5000);
}

function handleOrientation(){
  const player=document.getElementById("playerCentral");
  if(window.innerWidth>window.innerHeight){ player.classList.remove("portrait"); player.classList.add("landscape"); }
  else{ player.classList.remove("landscape"); player.classList.add("portrait"); }
}

window.addEventListener("orientationchange",handleOrientation);
window.addEventListener("resize",handleOrientation);
document.getElementById("playerCentral").addEventListener("mousemove",showCloseBtnTemporarily);
document.getElementById("playerCentral").addEventListener("click",showCloseBtnTemporarily);
document.getElementById("playerCentral").addEventListener("touchstart",showCloseBtnTemporarily);
document.getElementById("closeBtn").onclick=closePlayer;
</script>
</body>
</html>
